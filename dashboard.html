<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - G√≥c Truy·ªán C·ªßa Tui</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/slugify@1.6.6/slugify.min.js"></script>
    <style>
        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8">
        <div class="flex justify-between items-center mb-8 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-800">üëë Admin Dashboard</h1>
            <button onclick="logout()" class="text-sm text-red-500 hover:underline">ƒêƒÉng xu·∫•t</button>
        </div>

        <div id="config-section" class="mb-6 hidden">
            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 mb-4">
                <p class="text-sm text-yellow-800">üí° B·ªì c·∫ßn <strong>Personal Access Token</strong> (Quy·ªÅn: <code>public_repo</code>) ƒë·ªÉ Dashboard n√†y c√≥ th·ªÉ ghi file v√†o GitHub c·ªßa b·ªì.</p>
            </div>
            <label class="block mb-2 font-bold">GitHub Username:</label>
            <input type="text" id="gh-username" class="w-full p-2 border rounded mb-4" placeholder="V√≠ d·ª•: TrieuLM-2">
            
            <label class="block mb-2 font-bold">Repository Name:</label>
            <input type="text" id="gh-repo" class="w-full p-2 border rounded mb-4" placeholder="V√≠ d·ª•: goctruyencuatui">
            
            <label class="block mb-2 font-bold">GitHub Token:</label>
            <input type="password" id="gh-token" class="w-full p-2 border rounded mb-4" placeholder="ghp_xxxxxxxxxxxx">
            
            <button onclick="saveConfig()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 w-full">L∆∞u C·∫•u H√¨nh</button>
        </div>

        <div id="editor-section" class="hidden">
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block mb-1 font-semibold">Ch·ªçn Truy·ªán:</label>
                    <select id="story-folder" class="w-full p-2 border rounded bg-gray-50">
                        <option value="boyfriend-material">Boyfriend Material</option>
                        <option value="the-long-game">The Long Game</option>
                        <option value="the-foxhole-court">The Foxhole Court</option>
                        <option value="the-wolf-at-the-door">The Wolf at the Door</option>
                        <option value="red-white-and-royal-blue">Red, White & Royal Blue</option>
                    </select>
                </div>
                <div>
                    <label class="block mb-1 font-semibold">T√™n Truy·ªán (Parent):</label>
                    <input type="text" id="story-parent" class="w-full p-2 border rounded" placeholder="VD: Boyfriend Material">
                </div>
            </div>

            <div class="grid grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block mb-1 font-semibold">S·ªë Ch∆∞∆°ng:</label>
                    <input type="number" id="chap-num" class="w-full p-2 border rounded" placeholder="VD: 25">
                </div>
                <div class="col-span-2">
                    <label class="block mb-1 font-semibold">T√™n Ch∆∞∆°ng:</label>
                    <input type="text" id="chap-title" class="w-full p-2 border rounded" placeholder="VD: S·ª± Th·∫≠t V·ªÅ B·ªë">
                </div>
            </div>

            <div class="mb-4">
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="bilingual-mode" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600 relative"></div>
                    <span class="ml-3 text-sm font-medium text-gray-900">Ch·∫ø ƒë·ªô Song Ng·ªØ (T·ª± tr·ªôn ƒëo·∫°n vƒÉn)</span>
                </label>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block mb-1 font-bold text-blue-700">üáªüá≥ N·ªôi dung Ti·∫øng Vi·ªát:</label>
                    <textarea id="content-vi" class="w-full h-96 p-3 border rounded text-sm font-mono" placeholder="D√°n vƒÉn b·∫£n ti·∫øng Vi·ªát v√†o ƒë√¢y... C√°c ƒëo·∫°n c√°ch nhau 1 d√≤ng tr·ªëng."></textarea>
                </div>
                <div id="en-container">
                    <label class="block mb-1 font-bold text-red-700">üá∫üá∏ N·ªôi dung Ti·∫øng Anh:</label>
                    <textarea id="content-en" class="w-full h-96 p-3 border rounded text-sm font-mono" placeholder="Paste English text here... Paragraphs must match the Vietnamese side."></textarea>
                </div>
            </div>

            <button id="btn-publish" onclick="publishChapter()" class="w-full bg-green-600 text-white font-bold text-xl py-4 rounded-lg shadow hover:bg-green-700 transition transform active:scale-95">
                üöÄ ƒêƒÇNG CH∆Ø∆†NG L√äN GITHUB
            </button>
            <p id="status-msg" class="text-center mt-4 text-gray-600"></p>
        </div>
    </div>

    <script>
        // --- C·∫§U H√åNH ---
        const CONFIG_KEY = 'my_gh_config';
        let config = JSON.parse(localStorage.getItem(CONFIG_KEY)) || {};

        function checkAuth() {
            if (config.token && config.user && config.repo) {
                document.getElementById('config-section').classList.add('hidden');
                document.getElementById('editor-section').classList.remove('hidden');
            } else {
                document.getElementById('config-section').classList.remove('hidden');
                document.getElementById('editor-section').classList.add('hidden');
            }
        }

        function saveConfig() {
            const user = document.getElementById('gh-username').value;
            const repo = document.getElementById('gh-repo').value;
            const token = document.getElementById('gh-token').value;
            
            if(!user || !repo || !token) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin ƒëi b·ªì t√®o!");
            
            config = { user, repo, token };
            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            checkAuth();
        }

        function logout() {
            if(confirm("X√≥a c·∫•u h√¨nh & ƒëƒÉng xu·∫•t?")) {
                localStorage.removeItem(CONFIG_KEY);
                location.reload();
            }
        }

        // --- X·ª¨ L√ù SONG NG·ªÆ ---
        function mergeBilingual(viText, enText) {
            // T√°ch ƒëo·∫°n vƒÉn theo d√≤ng tr·ªëng (2 l·∫ßn xu·ªëng d√≤ng)
            const viParas = viText.split(/\n\s*\n/).filter(p => p.trim() !== "");
            const enParas = enText.split(/\n\s*\n/).filter(p => p.trim() !== "");
            
            let html = "";
            const maxLen = Math.max(viParas.length, enParas.length);

            for (let i = 0; i < maxLen; i++) {
                const vi = viParas[i] ? viParas[i].trim() : "";
                const en = enParas[i] ? enParas[i].trim() : "";

                if (vi) html += `<p class="lang-vi">${vi}</p>\n`;
                if (en) html += `<p class="lang-en">${en}</p>\n`;
                html += "\n"; // D√≤ng tr·ªëng cho d·ªÖ nh√¨n
            }
            return html;
        }

        function simpleFormat(text) {
            // Ch·ªâ th√™m th·∫ª p cho m·ªói ƒëo·∫°n
            return text.split(/\n\s*\n/).filter(p => p.trim()).map(p => `<p class="text-indent: 2em;">${p.trim()}</p>`).join('\n\n');
        }

        // --- G·ª¨I API ---
        async function publishChapter() {
            const btn = document.getElementById('btn-publish');
            const msg = document.getElementById('status-msg');
            const folder = document.getElementById('story-folder').value;
            const parentTitle = document.getElementById('story-parent').value;
            const chapNum = document.getElementById('chap-num').value;
            const chapTitle = document.getElementById('chap-title').value;
            const viContent = document.getElementById('content-vi').value;
            const enContent = document.getElementById('content-en').value;
            const isBilingual = document.getElementById('bilingual-mode').checked;

            if (!chapNum || !chapTitle) return alert("Thi·∫øu s·ªë ch∆∞∆°ng ho·∫∑c t√™n ch∆∞∆°ng r·ªìi!");

            btn.classList.add('loading');
            btn.innerText = "‚è≥ ƒêang ƒë·∫©y l√™n m√¢y...";
            msg.innerText = "ƒêang x·ª≠ l√Ω vƒÉn b·∫£n...";

            try {
                // 1. T·∫°o n·ªôi dung Body
                let bodyContent = "";
                if (isBilingual) {
                    bodyContent = mergeBilingual(viContent, enContent);
                } else {
                    bodyContent = simpleFormat(viContent);
                }

                // 2. T·∫°o File Markdown Ho√†n ch·ªânh
                const chapSlug = chapNum.toString().padStart(2, '0'); // 1 -> 01
                const fileName = `chap-${chapSlug}.md`;
                const filePath = `truyen/${folder}/${fileName}`;
                
                // N√∫t ƒëi·ªÅu h∆∞·ªõng th√¥ng minh
                const prevSlug = (parseInt(chapNum) - 1).toString().padStart(2, '0');
                const nextSlug = (parseInt(chapNum) + 1).toString().padStart(2, '0');

                const fileContent = `---
layout: default
title: Ch∆∞∆°ng ${chapNum}
description: "${chapTitle}"
parent: ${parentTitle}
nav_order: ${chapNum}
---

<div style="font-size: 0.9rem; color: #888; margin-bottom: 30px;">
  <a href="{{ site.baseurl }}/" style="text-decoration:none; color:#888;">Home</a> / 
  <a href="./" style="text-decoration:none; color:#888;">${parentTitle}</a> / 
  <span style="color:#2980b9;">Ch∆∞∆°ng ${chapNum}</span>
</div>

<div style="text-align: center; margin-bottom: 40px;">
    <h1 style="color: #2c3e50; margin-bottom: 10px; font-size: 2rem;">CH∆Ø∆†NG ${chapNum}</h1>
    <h2 style="font-size: 1.2rem; color: #7f8c8d; font-weight: normal; margin-top: 0;">${chapTitle}</h2>
</div>

<hr style="border: 0; border-top: 1px solid #eee; margin: 30px 0;">

<div class="chapter-content" style="line-height: 1.8; font-size: 1.1rem; color: #333; max-width: 800px; margin: 0 auto;">

${bodyContent}

</div>

<nav style="display: flex; justify-content: space-between; align-items: center; padding: 2rem 0; margin-top: 3rem; border-top: 2px solid #eee;">
  <a href="./chap-${prevSlug}" style="text-decoration: none; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white; font-weight: 600; transition: transform 0.2s;">
    ‚Üê Ch∆∞∆°ng tr∆∞·ªõc
  </a>
  <a href="./chap-${nextSlug}" style="text-decoration: none; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 8px; color: white; font-weight: 600; transition: transform 0.2s;">
    Ch∆∞∆°ng ti·∫øp ‚Üí
  </a>
</nav>
`;

                // 3. G·ª≠i l√™n GitHub API
                // Chuy·ªÉn n·ªôi dung sang Base64 (y√™u c·∫ßu c·ªßa GitHub API)
                // L∆∞u √Ω: btoa b·ªã l·ªói v·ªõi k√Ω t·ª± Unicode (Ti·∫øng Vi·ªát), ph·∫£i d√πng trick n√†y:
                const contentBase64 = btoa(unescape(encodeURIComponent(fileContent)));

                const apiUrl = `https://api.github.com/repos/${config.user}/${config.repo}/contents/${filePath}`;
                
                // Ki·ªÉm tra xem file c√≥ t·ªìn t·∫°i kh√¥ng ƒë·ªÉ l·∫•y SHA (n·∫øu update)
                let sha = null;
                try {
                    const checkRes = await fetch(apiUrl, {
                        headers: { 'Authorization': `token ${config.token}` }
                    });
                    if (checkRes.ok) {
                        const data = await checkRes.json();
                        sha = data.sha; // L·∫•y SHA ƒë·ªÉ ghi ƒë√®
                    }
                } catch(e) {}

                // G·ª≠i request PUT
                const putRes = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Dashboard: T·∫°o/Update ${fileName}`,
                        content: contentBase64,
                        sha: sha // N·∫øu null th√¨ l√† t·∫°o m·ªõi, n·∫øu c√≥ th√¨ l√† update
                    })
                });

                if (putRes.ok) {
                    msg.innerHTML = `‚úÖ <strong>Th√†nh c√¥ng!</strong> File <a href="https://github.com/${config.user}/${config.repo}/blob/master/${filePath}" target="_blank" class="text-blue-600 underline">${fileName}</a> ƒë√£ ƒë∆∞·ª£c t·∫°o. ƒê·ª£i 1-2p ƒë·ªÉ Web c·∫≠p nh·∫≠t.`;
                    // Reset form nh·∫π
                    document.getElementById('content-vi').value = "";
                    document.getElementById('content-en').value = "";
                    document.getElementById('chap-num').value = parseInt(chapNum) + 1; // T·ª± tƒÉng s·ªë ch∆∞∆°ng
                } else {
                    const err = await putRes.json();
                    throw new Error(err.message);
                }

            } catch (err) {
                alert("L·ªói r·ªìi b·ªì ∆°i: " + err.message);
                msg.innerText = "‚ùå Th·∫•t b·∫°i: " + err.message;
            } finally {
                btn.classList.remove('loading');
                btn.innerText = "üöÄ ƒêƒÇNG CH∆Ø∆†NG L√äN GITHUB";
            }
        }

        // Init
        checkAuth();
        
        // Toggle Bilingual UI
        document.getElementById('bilingual-mode').addEventListener('change', (e) => {
            const enDiv = document.getElementById('en-container');
            if (e.target.checked) enDiv.classList.remove('hidden');
            else enDiv.classList.add('hidden');
        });

    </script>
</body>
</html>