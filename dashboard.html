<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - G√≥c Truy·ªán C·ªßa Tui</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/slugify@1.6.6/slugify.min.js"></script>
    <style>
        .loading { opacity: 0.5; pointer-events: none; }
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">

    <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg p-8">
        <div class="flex justify-between items-center mb-8 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-800">üëë Admin Dashboard V2</h1>
            <button onclick="logout()" class="text-sm text-red-500 hover:underline">ƒêƒÉng xu·∫•t</button>
        </div>

        <div id="config-section" class="mb-6 hidden">
            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 mb-4">
                <p class="text-sm text-yellow-800">üí° C·∫ßn <strong>Personal Access Token</strong> (Quy·ªÅn: <code>public_repo</code>).</p>
            </div>
            <div class="grid grid-cols-3 gap-4">
                <input type="text" id="gh-username" class="p-2 border rounded" placeholder="GitHub Username">
                <input type="text" id="gh-repo" class="p-2 border rounded" placeholder="Repo Name">
                <input type="password" id="gh-token" class="p-2 border rounded" placeholder="GitHub Token (ghp_...)">
            </div>
            <button onclick="saveConfig()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 w-full">L∆∞u C·∫•u H√¨nh</button>
        </div>

        <div id="editor-section" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-bold mb-1">Th∆∞ m·ª•c truy·ªán:</label>
                    <select id="story-folder" class="w-full p-2 border rounded bg-gray-50">
                        <option value="boyfriend-material">Boyfriend Material</option>
                        <option value="the-long-game">The Long Game</option>
                        <option value="the-foxhole-court">The Foxhole Court</option>
                        <option value="the-wolf-at-the-door">The Wolf at the Door</option>
                        <option value="red-white-and-royal-blue">Red, White & Royal Blue</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">T√™n truy·ªán (Parent):</label>
                    <input type="text" id="story-parent" class="w-full p-2 border rounded" placeholder="T√™n truy·ªán...">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">S·ªë Ch∆∞∆°ng:</label>
                    <input type="number" id="chap-num" class="w-full p-2 border rounded" placeholder="1">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">T√™n Ch∆∞∆°ng:</label>
                    <input type="text" id="chap-title" class="w-full p-2 border rounded" placeholder="Ti√™u ƒë·ªÅ ch∆∞∆°ng...">
                </div>
            </div>

            <div id="error-box" class="hidden mb-4 p-3 bg-red-100 text-red-800 border border-red-200 rounded text-sm font-semibold"></div>
            
            <div id="warning-star" class="hidden mb-4 p-3 bg-orange-100 text-orange-900 border border-orange-200 rounded text-sm">
                ‚ö†Ô∏è <strong>C·∫£nh b√°o ph√¢n c√°ch:</strong> Ph√°t hi·ªán k√Ω t·ª± <code>***</code> trong vƒÉn b·∫£n Ti·∫øng Anh. H√£y ƒë·∫£m b·∫£o b√™n Ti·∫øng Vi·ªát c≈©ng c√≥ d√≤ng t∆∞∆°ng ·ª©ng (ho·∫∑c d√≤ng tr·ªëng) ƒë·ªÉ kh√¥ng b·ªã l·ªách ƒëo·∫°n vƒÉn!
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <div class="flex justify-between mb-1 items-end">
                        <label class="font-bold text-blue-700">üáªüá≥ Ti·∫øng Vi·ªát</label>
                        <span class="text-xs font-mono text-gray-500" id="count-vi">0 ƒëo·∫°n</span>
                    </div>
                    <textarea id="content-vi" class="w-full h-[500px] p-3 border border-blue-200 rounded text-sm font-mono focus:ring-2 focus:ring-blue-500 outline-none resize-none" 
                    placeholder="D√°n n·ªôi dung Ti·∫øng Vi·ªát v√†o ƒë√¢y..." oninput="validateInputs()"></textarea>
                </div>
                
                <div>
                    <div class="flex justify-between mb-1 items-end">
                        <label class="font-bold text-red-700">üá∫üá∏ Ti·∫øng Anh</label>
                        <span class="text-xs font-mono text-gray-500" id="count-en">0 ƒëo·∫°n</span>
                    </div>
                    <textarea id="content-en" class="w-full h-[500px] p-3 border border-red-200 rounded text-sm font-mono focus:ring-2 focus:ring-red-500 outline-none resize-none" 
                    placeholder="Paste English text here..." oninput="validateInputs()"></textarea>
                </div>
            </div>

            <div class="mb-4 flex items-center justify-between">
                 <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="bilingual-mode" class="sr-only peer" checked disabled>
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-green-600 relative after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                    <span class="ml-3 text-sm font-medium text-gray-900">Ch·∫ø ƒë·ªô Song Ng·ªØ (Lu√¥n B·∫≠t)</span>
                </label>
                <span id="status-match" class="text-sm font-bold text-gray-400">Ch∆∞a c√≥ n·ªôi dung</span>
            </div>

            <button id="btn-publish" onclick="publishChapter()" class="w-full bg-gray-400 text-white font-bold text-xl py-4 rounded-lg shadow transition transform active:scale-[0.99]" disabled>
                üöÄ ƒêƒÇNG CH∆Ø∆†NG L√äN GITHUB
            </button>
            <div id="status-msg" class="text-center mt-4 text-sm font-mono"></div>
        </div>
    </div>

    <script>
        const CONFIG_KEY = 'gh_admin_config';
        let config = JSON.parse(localStorage.getItem(CONFIG_KEY)) || {};

        // --- AUTH & CONFIG ---
        function checkAuth() {
            if (config.token && config.user && config.repo) {
                document.getElementById('config-section').classList.add('hidden');
                document.getElementById('editor-section').classList.remove('hidden');
            } else {
                document.getElementById('config-section').classList.remove('hidden');
                document.getElementById('editor-section').classList.add('hidden');
            }
        }

        function saveConfig() {
            const user = document.getElementById('gh-username').value.trim();
            const repo = document.getElementById('gh-repo').value.trim();
            const token = document.getElementById('gh-token').value.trim();
            if(!user || !repo || !token) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin ƒëi b·ªì!");
            config = { user, repo, token };
            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            checkAuth();
        }

        function logout() {
            if(confirm("ƒêƒÉng xu·∫•t?")) {
                localStorage.removeItem(CONFIG_KEY);
                location.reload();
            }
        }

        // --- CORE LOGIC: T√ÅCH ƒêO·∫†N & KI·ªÇM TRA ---
        
        // H√†m t√°ch ƒëo·∫°n: T√°ch b·∫±ng xu·ªëng d√≤ng (\n)
        function splitParas(text) {
            return text.split(/\n+/).map(p => p.trim()).filter(p => p.length > 0);
        }

        function validateInputs() {
            const viVal = document.getElementById('content-vi').value;
            const enVal = document.getElementById('content-en').value;
            const btn = document.getElementById('btn-publish');
            const errBox = document.getElementById('error-box');
            const warnStar = document.getElementById('warning-star');
            const statusMatch = document.getElementById('status-match');

            const parasVi = splitParas(viVal);
            const parasEn = splitParas(enVal);
            const cVi = parasVi.length;
            const cEn = parasEn.length;

            // 1. C·∫≠p nh·∫≠t s·ªë ƒë·∫øm
            document.getElementById('count-vi').innerText = `${cVi} ƒëo·∫°n`;
            document.getElementById('count-en').innerText = `${cEn} ƒëo·∫°n`;

            // 2. Ki·ªÉm tra l·ªách d√≤ng
            if (cVi !== cEn) {
                const diff = Math.abs(cVi - cEn);
                errBox.classList.remove('hidden');
                errBox.innerHTML = `‚õî <strong>L·ªñI L·ªÜCH D√íNG:</strong> B√™n Ti·∫øng Vi·ªát c√≥ <b>${cVi}</b> ƒëo·∫°n, b√™n Ti·∫øng Anh c√≥ <b>${cEn}</b> ƒëo·∫°n. L·ªách <b>${diff}</b> ƒëo·∫°n.<br>H√£y ki·ªÉm tra l·∫°i c√°c d·∫•u xu·ªëng d√≤ng!`;
                
                btn.disabled = true;
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                
                document.getElementById('count-vi').classList.add('text-red-600');
                document.getElementById('count-en').classList.add('text-red-600');
                statusMatch.innerHTML = '<span class="text-red-600">‚ùå Ch∆∞a kh·ªõp</span>';
            } else {
                errBox.classList.add('hidden');
                document.getElementById('count-vi').classList.remove('text-red-600');
                document.getElementById('count-en').classList.remove('text-red-600');
                
                if (cVi > 0) {
                    btn.disabled = false;
                    btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    btn.classList.add('bg-green-600', 'hover:bg-green-700');
                    statusMatch.innerHTML = '<span class="text-green-600">‚úÖ ƒê√£ kh·ªõp</span>';
                } else {
                    statusMatch.innerText = "Ch∆∞a c√≥ n·ªôi dung";
                }
            }

            // 3. Ki·ªÉm tra k√Ω t·ª± *** (Scene Break)
            // T√¨m c√°c bi·∫øn th·ªÉ: ***, * * *, * * *, v.v.
            const starRegex = /(\*\s*){3,}/; 
            if (starRegex.test(enVal) || starRegex.test(viVal)) {
                warnStar.classList.remove('hidden');
            } else {
                warnStar.classList.add('hidden');
            }
        }

        function generateBodyHTML(viVal, enVal) {
            const viP = splitParas(viVal);
            const enP = splitParas(enVal);
            let html = "";
            
            for (let i = 0; i < viP.length; i++) {
                // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho d√≤ng ph√¢n c√°ch ***
                const isSeparator = /^(\*\s*){3,}$/.test(viP[i]) || /^(\*\s*){3,}$/.test(enP[i]);
                
                if (isSeparator) {
                    html += `<p style="text-align: center; margin: 3rem 0; font-size: 1.5rem; color: #ccc;">* * *</p>\n\n`;
                } else {
                    html += `<p class="lang-vi">${viP[i]}</p>\n`;
                    html += `<p class="lang-en">${enP[i]}</p>\n\n`;
                }
            }
            return html;
        }

        // --- PUBLISH ---
        async function publishChapter() {
            const btn = document.getElementById('btn-publish');
            const msg = document.getElementById('status-msg');
            
            // L·∫•y d·ªØ li·ªáu
            const folder = document.getElementById('story-folder').value;
            const parent = document.getElementById('story-parent').value;
            const num = document.getElementById('chap-num').value;
            const title = document.getElementById('chap-title').value;
            const viVal = document.getElementById('content-vi').value;
            const enVal = document.getElementById('content-en').value;

            btn.innerText = "‚è≥ ƒêang x·ª≠ l√Ω...";
            
            try {
                const bodyHTML = generateBodyHTML(viVal, enVal);
                
                // T·∫°o file path & content
                const chapSlug = num.toString().padStart(2, '0');
                const fileName = `chap-${chapSlug}.md`;
                const path = `truyen/${folder}/${fileName}`;
                const prev = (parseInt(num) - 1).toString().padStart(2, '0');
                const next = (parseInt(num) + 1).toString().padStart(2, '0');

                const fileContent = `---
layout: default
title: Ch∆∞∆°ng ${num}
description: "${title}"
parent: ${parent}
nav_order: ${num}
---

<div style="font-size: 0.9rem; color: #888; margin-bottom: 30px;">
  <a href="{{ site.baseurl }}/" style="text-decoration:none; color:#888;">Home</a> / 
  <a href="./" style="text-decoration:none; color:#888;">${parent}</a> / 
  <span style="color:#2980b9;">Ch∆∞∆°ng ${num}</span>
</div>

<div style="text-align: center; margin-bottom: 40px;">
    <h1 style="color: #2c3e50; margin-bottom: 10px; font-size: 2rem;">CH∆Ø∆†NG ${num}</h1>
    <h2 style="font-size: 1.2rem; color: #7f8c8d; font-weight: normal; margin-top: 0;">${title}</h2>
</div>

<hr style="border: 0; border-top: 1px solid #eee; margin: 30px 0;">

<div class="chapter-content" style="line-height: 1.8; font-size: 1.1rem; color: #333; max-width: 800px; margin: 0 auto;">

${bodyHTML}

</div>

<nav style="display: flex; justify-content: space-between; align-items: center; padding: 2rem 0; margin-top: 3rem; border-top: 2px solid #eee;">
  <a href="./chap-${prev}" style="text-decoration: none; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white; font-weight: 600; transition: transform 0.2s;">
    ‚Üê Ch∆∞∆°ng tr∆∞·ªõc
  </a>
  <a href="./chap-${next}" style="text-decoration: none; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 8px; color: white; font-weight: 600; transition: transform 0.2s;">
    Ch∆∞∆°ng ti·∫øp ‚Üí
  </a>
</nav>
`;
                // G·ª≠i API
                const contentBase64 = btoa(unescape(encodeURIComponent(fileContent)));
                const apiUrl = `https://api.github.com/repos/${config.user}/${config.repo}/contents/${path}`;

                // Check SHA
                let sha = null;
                try {
                    const c = await fetch(apiUrl, { headers: { 'Authorization': `token ${config.token}` }});
                    if(c.ok) { const d = await c.json(); sha = d.sha; }
                } catch(e){}

                const res = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Dashboard: Up ch∆∞∆°ng ${num}`,
                        content: contentBase64,
                        sha: sha
                    })
                });

                if(res.ok) {
                    msg.innerHTML = `<span class="text-green-600 font-bold">‚úÖ ƒê√£ xong!</span> File: ${fileName}`;
                    // Reset
                    document.getElementById('content-vi').value = '';
                    document.getElementById('content-en').value = '';
                    document.getElementById('chap-num').value = parseInt(num) + 1;
                    validateInputs();
                } else {
                    const err = await res.json();
                    throw new Error(err.message);
                }

            } catch(e) {
                alert(e.message);
                msg.innerText = "‚ùå L·ªói: " + e.message;
            } finally {
                btn.innerText = "üöÄ ƒêƒÇNG CH∆Ø∆†NG L√äN GITHUB";
            }
        }

        // Auto fill
        document.getElementById('story-folder').addEventListener('change', (e) => {
            const map = {
                'boyfriend-material': 'Boyfriend Material',
                'the-long-game': 'The Long Game',
                'the-foxhole-court': 'The Foxhole Court',
                'the-wolf-at-the-door': 'The Wolf at the Door',
                'red-white-and-royal-blue': 'Red, White & Royal Blue'
            };
            document.getElementById('story-parent').value = map[e.target.value] || "";
        });

        checkAuth();
    </script>
</body>
</html>